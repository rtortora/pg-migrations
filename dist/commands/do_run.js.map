{"version":3,"sources":["../../src/commands/do_run.js"],"names":["sortBy","require","module","exports","host","migration","direction","args","Error","withMigrationLock","migrationStatusMap","refresh","migrations","force","get","key","applied","sortedUnappliedKeys","Array","from","keys","filter","local","sort","push","appliedKeys","sortedKeys","migrated_at","targetKey","length","dryrun","console","log","path","conn","default","execute","bind","setMigrationStatus","disableTransaction","withTransaction","exception","process","exit","doRun"],"mappings":";;;;;;AAAA,MAAMA,MAAM,GAAGC,OAAO,CAAC,eAAD,CAAtB;;AAEAC,MAAM,CAACC,OAAP;AAAA;AAAA;AAAA,iCAAiB,WAAqBC,IAArB,EAA2BC,SAA3B,EAAsCC,SAAtC,EAAiDC,IAAjD,EAAuD;AACtE,QAAID,SAAS,IAAI,IAAb,IAAqBA,SAAS,IAAI,MAAtC,EAA8C;AAC5C,YAAM,IAAIE,KAAJ,CAAW,mEAAkEF,SAAU,GAAvF,CAAN;AACD;;AACD,UAAMF,IAAI,CAACK,iBAAL;AAAA;AAAA,sBAAuB,aAAU;AACrC,YAAMC,kBAAkB,SAASN,IAAI,CAACM,kBAAL,CAAwB;AAAEC,QAAAA,OAAO,EAAE;AAAX,OAAxB,CAAjC,CADqC,CAErC;;AACA,UAAIC,UAAJ;;AACA,UAAIP,SAAJ,EAAe;AACb,YAAIE,IAAI,CAACM,KAAL,IACCP,SAAS,IAAI,IAAb,IAAqB,CAACI,kBAAkB,CAACI,GAAnB,CAAuBT,SAAS,CAACU,GAAjC,EAAsCC,OAD7D,IAECV,SAAS,IAAI,MAAb,IAAuBI,kBAAkB,CAACI,GAAnB,CAAuBT,SAAS,CAACU,GAAjC,EAAsCC,OAFlE,EAE4E;AAC1EJ,UAAAA,UAAU,GAAG,CAACP,SAAD,CAAb;AACD,SAJD,MAIO;AACLO,UAAAA,UAAU,GAAG,EAAb;AACD;AACF,OARD,MAQO,IAAIN,SAAS,IAAI,IAAjB,EAAuB;AAC5BM,QAAAA,UAAU,GAAG,EAAb;AACA,cAAMK,mBAAmB,GAAGC,KAAK,CAACC,IAAN,CAAWT,kBAAkB,CAACU,IAAnB,EAAX,EAAsCC,MAAtC,CAA8CN,GAAD,IAAO;AAC9E,iBAAO,CAACL,kBAAkB,CAACI,GAAnB,CAAuBC,GAAvB,EAA4BC,OAA7B,IAAwCN,kBAAkB,CAACI,GAAnB,CAAuBC,GAAvB,EAA4BO,KAA3E;AACD,SAF2B,EAEzBC,IAFyB,EAA5B;;AAGA,aAAK,IAAIR,GAAT,IAAgBE,mBAAhB,EAAqC;AACnCL,UAAAA,UAAU,CAACY,IAAX,CAAgBd,kBAAkB,CAACI,GAAnB,CAAuBC,GAAvB,EAA4BO,KAA5C;AACD;AACF,OARM,MAQA,IAAIhB,SAAS,IAAI,MAAjB,EAAyB;AAC9B,cAAMmB,WAAW,GAAGP,KAAK,CAACC,IAAN,CAAWT,kBAAkB,CAACU,IAAnB,EAAX,EAAsCC,MAAtC,CAA8CN,GAAD,IAAO;AACtE,iBAAOL,kBAAkB,CAACI,GAAnB,CAAuBC,GAAvB,EAA4BC,OAA5B,IAAuCN,kBAAkB,CAACI,GAAnB,CAAuBC,GAAvB,EAA4BO,KAA1E;AACD,SAFmB,CAApB;AAGA,cAAMI,UAAU,GAAG1B,MAAM,CAACyB,WAAD,EAAeV,GAAD,IAAO;AAC5C,iBAAOL,kBAAkB,CAACI,GAAnB,CAAuBC,GAAvB,EAA4BC,OAA5B,CAAoCW,WAA3C;AACD,SAFwB,CAAzB;AAGA,cAAMC,SAAS,GAAGF,UAAU,CAACA,UAAU,CAACG,MAAX,GAAoB,CAArB,CAA5B;;AACA,YAAID,SAAJ,EAAe;AACbhB,UAAAA,UAAU,GAAG,CAACF,kBAAkB,CAACI,GAAnB,CAAuBc,SAAvB,EAAkCN,KAAnC,CAAb;AACD,SAFD,MAEO;AACLV,UAAAA,UAAU,GAAG,EAAb;AACD;AACF,OAbM,MAaA;AACL,cAAM,IAAIJ,KAAJ,CAAW,YAAX,CAAN;AACD;;AAED,UAAID,IAAI,CAACuB,MAAT,EAAiB;AACfC,QAAAA,OAAO,CAACC,GAAR,CAAa,uBAAsB1B,SAAU,qCAAoCM,UAAU,CAACiB,MAAO,GAAnG;;AACA,aAAK,IAAIxB,SAAT,IAAsBO,UAAtB,EAAkC;AAChCmB,UAAAA,OAAO,CAACC,GAAR,CAAa,GAAE3B,SAAS,CAACU,GAAI,IAAGV,SAAS,CAAC4B,IAAK,EAA/C;AACD;;AACD;AACD,OA3CoC,CA6CrC;;;AACA,YAAMC,IAAI,SAAS9B,IAAI,CAAC8B,IAAL,EAAnB;;AACA,WAAK,IAAI7B,SAAT,IAAsBO,UAAtB,EAAkC;AAChC,YAAIV,MAAM,GAAGD,OAAO,CAACI,SAAS,CAAC4B,IAAX,CAApB;;AACA,YAAI/B,MAAM,CAACiC,OAAX,EAAoB;AAClBjC,UAAAA,MAAM,GAAGA,MAAM,CAACiC,OAAhB;AACD;;AACD,YAAI,OAAOjC,MAAM,CAACI,SAAD,CAAb,KAA8B,UAAlC,EAA8C;AAC5CyB,UAAAA,OAAO,CAACC,GAAR,CAAa,QAAO1B,SAAU,IAAGD,SAAS,CAACU,GAAI,IAAGV,SAAS,CAAC4B,IAAK,EAAjE;;AACA,cAAI;AACF,kBAAMG,OAAO;AAAA;AAAA;AAAA,4CAAG,aAAS;AACvB,sBAAOlC,MAAM,CAACI,SAAD,CAAN,CAAkB+B,IAAlB,CAAuBnC,MAAvB,EAA+BgC,IAA/B,GAAP;AACA,sBAAM9B,IAAI,CAACkC,kBAAL,CAAwBjC,SAAxB,EAAmCC,SAAnC,CAAN;AACAyB,gBAAAA,OAAO,CAACC,GAAR,CAAa,QAAO1B,SAAU,IAAGD,SAAS,CAACU,GAAI,IAAGV,SAAS,CAAC4B,IAAK,EAAjE;AACD,eAJY;;AAAA,8BAAPG,OAAO;AAAA;AAAA;AAAA,eAAb;;AAKA,gBAAIlC,MAAM,CAACqC,kBAAX,EAA+B;AAC7B,oBAAMH,OAAO,EAAb;AACD,aAFD,MAEO;AACL,oBAAMhC,IAAI,CAACoC,eAAL,CAAqBJ,OAArB,CAAN;AACD;AACF,WAXD,CAWE,OAAMK,SAAN,EAAiB;AACjBV,YAAAA,OAAO,CAACC,GAAR,CAAa,QAAO1B,SAAU,IAAGD,SAAS,CAACU,GAAI,IAAGV,SAAS,CAAC4B,IAAK,EAAjE;AACAF,YAAAA,OAAO,CAACC,GAAR,CAAYS,SAAZ;AACAC,YAAAA,OAAO,CAACC,IAAR,CAAa,CAAb;AACD;AACF,SAlBD,MAkBO;AACL,gBAAMvC,IAAI,CAACoC,eAAL;AAAA;AAAA,4BAAqB,aAAS;AAClC,kBAAMpC,IAAI,CAACkC,kBAAL,CAAwBjC,SAAxB,EAAmCC,SAAnC,CAAN;AACA,kBAAM,IAAIE,KAAJ,CAAW,GAAEF,SAAU,IAAGD,SAAS,CAACU,GAAI,IAAGV,SAAS,CAAC4B,IAAK,sBAAqB3B,SAAU,GAAzF,CAAN;AACD,WAHK,EAAN;AAID;AACF;;AAEDyB,MAAAA,OAAO,CAACC,GAAR,CAAa,WAAb;AACD,KA/EK,EAAN;AAgFD,GApFD;;AAAA,WAAgCY,KAAhC;AAAA;AAAA;;AAAA,SAAgCA,KAAhC;AAAA","sourcesContent":["const sortBy = require('lodash.sortby');\n\nmodule.exports = async function doRun(host, migration, direction, args) {\n  if (direction != \"up\" && direction != \"down\") {\n    throw new Error(`Unhandled migration direction, must be 'up' or 'down' but was: '${direction}'`);\n  }\n  await host.withMigrationLock(async ()=>{\n    const migrationStatusMap = await host.migrationStatusMap({ refresh: true });\n    // Determine which migrations to run\n    let migrations;\n    if (migration) {\n      if (args.force ||\n          (direction == 'up' && !migrationStatusMap.get(migration.key).applied) ||\n          (direction == 'down' && migrationStatusMap.get(migration.key).applied)) {\n        migrations = [migration];\n      } else {\n        migrations = [];\n      }\n    } else if (direction == 'up') {\n      migrations = [];\n      const sortedUnappliedKeys = Array.from(migrationStatusMap.keys()).filter((key)=>{\n        return !migrationStatusMap.get(key).applied && migrationStatusMap.get(key).local;\n      }).sort();\n      for (let key of sortedUnappliedKeys) {\n        migrations.push(migrationStatusMap.get(key).local);\n      }\n    } else if (direction == 'down') {\n      const appliedKeys = Array.from(migrationStatusMap.keys()).filter((key)=>{\n        return migrationStatusMap.get(key).applied && migrationStatusMap.get(key).local;\n      });\n      const sortedKeys = sortBy(appliedKeys, (key)=>{\n        return migrationStatusMap.get(key).applied.migrated_at;\n      });\n      const targetKey = sortedKeys[sortedKeys.length - 1];\n      if (targetKey) {\n        migrations = [migrationStatusMap.get(targetKey).local];\n      } else {\n        migrations = [];\n      }\n    } else {\n      throw new Error(`Unexpected`);\n    }\n\n    if (args.dryrun) {\n      console.log(`Dry run, would run '${direction}' on these migrations in order: (x${migrations.length})`);\n      for (let migration of migrations) {\n        console.log(`${migration.key} ${migration.path}`);\n      }\n      return;\n    }\n\n    // Actually run the migrations\n    const conn = await host.conn();\n    for (let migration of migrations) {\n      let module = require(migration.path);\n      if (module.default) {\n        module = module.default;\n      }\n      if (typeof(module[direction]) === 'function') {\n        console.log(`.... ${direction} ${migration.key} ${migration.path}`);\n        try {\n          const execute = async()=>{\n            await (module[direction].bind(module, conn)());\n            await host.setMigrationStatus(migration, direction);\n            console.log(`OKAY ${direction} ${migration.key} ${migration.path}`);\n          };\n          if (module.disableTransaction) {\n            await execute();\n          } else {\n            await host.withTransaction(execute);\n          }\n        } catch(exception) {\n          console.log(`FAIL ${direction} ${migration.key} ${migration.path}`);\n          console.log(exception);\n          process.exit(1);\n        }\n      } else {\n        await host.withTransaction(async()=>{\n          await host.setMigrationStatus(migration, direction);\n          throw new Error(`${direction} ${migration.key} ${migration.path} (no such function ${direction})`);\n        });\n      }\n    }\n\n    console.log(`Complete!`);\n  });\n}\n"],"file":"do_run.js"}